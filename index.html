<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Rivin's Weight Tracker</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

        <script>
            const ENCRYPTED_KEY_COOKIE = "encryptedKey";
    
            function getCookie(name) {
                const cookies = document.cookie.split("; ");
                for (let cookie of cookies) {
                    const [cookieName, cookieValue] = cookie.split("=");
                    if (cookieName === name) return cookieValue;
                }
                return null;
            }
    
            function setCookie(name, value, days) {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + value + "; path=/" + expires;
            }

            async function validateEncryptionCookie() {

                const response = await fetch(`${baseURL}/login/bhavin/validateEncryptionKey`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ encryptedKey: getCookie(ENCRYPTED_KEY_COOKIE) }),
                });

                const data = await response.json();
                return data.loginSuccess;
            }
    
            async function checkAccess() {
                const isEncrptionKeyValid = await validateEncryptionCookie();

                if (isEncrptionKeyValid) {
                    document.getElementById("container").style.display = "block";
                    return;
                }

                let enteredPasscode = prompt("Enter Passcode:");

                const response = await fetch(`${baseURL}/login/bhavin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passcode: enteredPasscode }),
                });

                const data = await response.json();
                const loginSuccess = data.loginSuccess;
                const loginEncryptionKey = data.encryptedKey;

                if (loginSuccess === true) {
                    setCookie(ENCRYPTED_KEY_COOKIE, loginEncryptionKey, 7); // Cookie valid for 7 day
                    document.getElementById("container").style.display = "block";
                } else {
                    alert("Incorrect Passcode. Access Denied.");
                    document.getElementById("container").style.display = "none";
                    checkAccess(); // Keep asking until correct passcode is entered
                }
            }
    
            window.onload = checkAccess;
        </script>

        <style>
            /* @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            } */
            #loadingOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(255, 255, 255, 1); /* Semi-transparent white */
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .spinner {
                /* width: 50px;
                height: 50px;
                border: 6px solid #007bff;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite; */

                width: 72px;
                height: 72px;
                border-radius: 50%;
                display: inline-block;
                border-top: 3px solid #007bff;
                border-right: 3px solid transparent;
                box-sizing: border-box;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            #container{
                display: none;
            }

            body {
                font-family: 'Montserrat', sans-serif;
                background-color: #f8f9fa;
                color: #343a40;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
            }
    
            .container {
                width: 90%;
                max-width: 800px;
                padding: 20px;
            }
    
            .header {
                text-align: center;
                margin-bottom: 30px;
            }
    
            .header h1 {
                font-size: 2.5em;
                color: #007bff;
                margin-bottom: 5px;
            }
    
            .header p {
                font-size: 1.1em;
                color: #6c757d;
            }
    
            .card {
                background-color: white;
                border-radius: 10px;
                /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
                margin-top: -40px;
                margin-bottom: 50px;
                /* padding: 1px 15px 15px 15px; */
                /* opacity: 0; Initially hidden */
                /* animation: fadeIn 0.8s ease-in-out forwards; */
            }
    
            .card h2 {
                color: #343a40;
                margin-bottom: 20px;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 10px;
            }

            .card h4 {
                color: #343a40;
                margin-top: 4px;
                margin-bottom: 8px;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 10px;
            }
    
            /* form {
                display: flex;
                flex-direction: column;
            } */

            /* #datePicker{
                text-align: center;
                width: 95%;
            } */

            .weightFormInputsDiv {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 25px;
            }

            .weightFormInputs {
                flex: 1;
                min-width: 1px;
            }

            .weightFormInputs input{
                width: 100%;
                height: 50%;
                padding: 8px;
                /* font-size: 16px; */
            }
    
            input[type="date"], input[type="number"] {
                /* margin-bottom: 4px; */
                background-color: white;
                color: black;
                border: 1px solid #ced4da;
                border-radius: 10px;
                font-size: 16px;
                /* width: 92%; */
            }
            input[type="date"]{
                appearance: none;
                -webkit-appearance: none;
            }
    
            .weightFormInputs button {
                width: 100%;
                padding: 8px 0px;
                height: 50%;
                /* line-height: normal; */
                box-sizing: content-box;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
            }
    
            button:hover {
                background-color: #0056b3;
            }
    
            table {
                width: 100%;
                border-collapse: collapse;
            }
    
            th, td {
                padding: 12px 8px 12px 8px;
                text-align: center;
                border-bottom: 1px solid #dee2e6;
            }
    
            th {
                background-color: #f2f2f2;
                font-weight: 600;
            }
    
            .chart-container {
                width: 100%;
                /* height: 400px; */
                height: 35vh;
            }
    
            .progress-bar-container {
                width: 100%;
                /* background-color: #e9ecef; */
                background-color: #d0d5d6;
                /* background-color: lightgrey; */
                border-radius: 5px;
                height: 20px;
                margin-bottom: 5px;
            }
    
            .progress-bar {
                height: 100%;
                background-color: #007bff;
                width: 0%;
                border-radius: 5px;
                transition: width 0.5s ease-in-out;
            }
    
            .progress-bar-ridham {
                background-color: #28a745;
            }
    
            .progress-text {
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            #bhavinProgressText{
                /* color: #007bff; */
                color: white;
                font-weight: bold;
                margin-left: 4px;
                margin-right: 20px;
            }

            #ridhamProgressText{
                /* color: #28a745; */
                color: white;
                font-weight: bold;
                margin-left: 4px;
            }

            .progress-container {
                display: flex;
                align-items: center; /* Align vertically */
            }
            
            #bhavinProgressTextDiv{
                margin-right: 18.13px;
            }

            #ridhamProgressTextDiv{
                margin-right: 10px;
            }

            .progress-bar-container {
                flex-grow: 1; /* Makes the progress bar take up the remaining space */
                background-color: #ddd;
                position: relative;
            }

            .progress-bar {
                height: 100%;
                width: 0%; /* Dynamically change width with JS */
                /* background-color: #4caf50; */
            }

            .progress-text span {
                position: absolute;
                width: 100%;
                text-align: center;
                color: white;
                /* line-height: 10px; */
                font-size: 12px;
            }

            /* Flexbox container for the progress cards */
            .progress-cards {
                display: flex;
                justify-content: space-between;
                gap: 6px; /* Space between the cards */
                /* margin-bottom: 30px; */
            }

            .card {
                background-color: white;
                border-radius: 10px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                padding: 4px 8px 4px 8px;
                flex: 1;
                min-width: 30%; /* Ensures each card doesn't shrink too much */
                box-sizing: border-box;
            }

            .card h2 {
                color: #343a40;
                margin-bottom: 20px;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 10px;
            }

            /* Optional: You can also tweak the width and margins of other elements to maintain consistency */
            .card .progress-text {
                font-size: 16px;
                margin-bottom: 5px;
            }
        </style>
    </head>
    <body>
    
        <div class="container" id="container">
            <div class="header">
                <!-- <h1>Rivin's Weight Tracker</h1> -->
            </div>

            <div id="loadingOverlay">
                <div class="spinner"></div>
            </div>            
        
            <!-- New container for horizontal alignment of the 3 cards -->
            <div class="progress-cards">
                <div class="card">
                    <h4>Day One Progress</h4>
                    <div id="dayOneProgress"></div>
                </div>
                <!-- New: Current Month Progress -->
                <div class="card">
                    <h4 id="currentMonthProgressTitle"></h4>
                    <div id="currentMonthProgress"></div>
                </div>
            
                <div class="card">
                    <h4>Weekly Progress</h4>
                    <div id="weeklyProgress"></div>
                </div>
            </div>
            
            <!-- Move Overall Progress to the Bottom -->
            <div class="card">
                <h4>Goal Achieved</h4>
                
                <div class="progress-container">
                    <span class="progress-text" id="bhavinProgressTextDiv">Bhavin:</span>
                    <div class="progress-bar-container">
                        <div id="bhavinProgressBar" class="progress-bar">
                            <span id="bhavinProgressText">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <span class="progress-text" id="ridhamProgressTextDiv">Ridham:</span>
                    <div class="progress-bar-container">
                        <div id="ridhamProgressBar" class="progress-bar progress-bar-ridham">
                            <span id="ridhamProgressText">0%</span>
                        </div>
                    </div>
                </div>
            </div>                    
        
            <div class="card">
                <h4>Weight Chart</h4>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        
            <!-- <div class="card">
                <h2>Add/Update Weight</h2>
                <form id="weightForm">
                    <input type="date" name="date" id="datePicker" required>
                    <input type="number" step="0.001" name="my_weight" placeholder="Bhavin's Weight (kg)" inputmode="decimal">
                    <input type="number" step="0.001" name="wife_weight" placeholder="Ridham's Weight (kg)" inputmode="decimal">
                    <button type="submit">Add weight</button>
                </form>
            </div> -->

            <div class="card">
                <h4>Add/Update Weight</h4>
                <form id="weightForm">
                    <div class="weightFormInputsDiv">
                        <div class="weightFormInputs">
                            <input type="date" name="date" id="datePicker" required>
                        </div>
                        <div class="weightFormInputs">
                            <input type="number" step="0.001" name="my_weight" placeholder="Bhavin" inputmode="decimal">
                        </div>
                        <div class="weightFormInputs">
                            <input type="number" step="0.001" name="wife_weight" placeholder="Ridham" inputmode="decimal">
                        </div>
                        <div class="weightFormInputs">
                            <button type="submit">+</button>
                        </div>
                    </div>
                </form>
            </div>
        
            <div class="card">
                <h4>Weight Log</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bhavin's Weight</th>
                            <th>Ridham's Weight</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="weightTable"></tbody>
                </table>
            </div>
        </div>

    <script>
        // Set the default value of the date input to today's date
        document.addEventListener("DOMContentLoaded", function () {
            const today = new Date();
            const localDate = today.toLocaleDateString('en-CA'); // Formats the date in YYYY-MM-DD format for local timezone
            document.getElementById("datePicker").value = localDate;

            const monthName = today.toLocaleString('default', { month: 'long' }); // Get full month name
            document.getElementById("currentMonthProgressTitle").textContent = `${monthName} Progress`;
        });

        let weightChartInstance = null; // Store the chart instance globally
        let baseURL = 'https://weight-tracker-backend-sfzg.onrender.com'
        // let baseURL = 'http://localhost:8080'

        async function fetchAndUpdate() {
            
            document.getElementById("loadingOverlay").style.display = "flex";

            try {

                const response = await fetch(`${baseURL}/api/weights`);
                const data = await response.json();

                // ✅ Sort by date (newest to oldest)
                data.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Update Table
                const table = document.getElementById('weightTable');
                table.innerHTML = '';
                data.forEach(row => {
                    const [year, month, day] = row.date.split("-").map(Number);
                    const dateObj = new Date(year, month - 1, day); // Explicitly set local date
                    const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });

                    const myWeight = row.myWeight !== null ? row.myWeight : "–";
                    const wifeWeight = row.wifeWeight !== null ? row.wifeWeight : "–";

                    const tr = `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>${myWeight}</td>
                            <td>${wifeWeight}</td>
                            <td><button onclick="deleteWeight(${row.id})" style="background:#fb5f63;color:white;border:none;padding:8px;width:35px;height:35px;border-radius:50px;cursor:pointer;font-weight:bold;">X</button></td>
                        </tr>
                    `;
                    table.innerHTML += tr;
                });

                // Update Graph
                const dates = data.map(d => {
                    let dateObj = new Date(d.date + "T00:00:00"); // Ensures the local timezone is used
                    return dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
                }).reverse();
                const myWeights = data.map(d => d.myWeight).reverse();
                const wifeWeights = data.map(d => d.wifeWeight).reverse();

                const ctx = document.getElementById('weightChart').getContext('2d');

                if (weightChartInstance) {
                    weightChartInstance.destroy();
                }

                Chart.defaults.animation = false; // Disable animation before creating a new chart

                weightChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { label: "Bhavin's Weight", data: myWeights, borderColor: "#007bff", backgroundColor: "rgba(0,123,255,0.1)", fill: true, borderWidth: 1, pointRadius: 2, pointHoverRadius: 7 },
                            { label: "Ridham's Weight", data: wifeWeights, borderColor: "#28a745", backgroundColor: "rgba(40,167,69,0.1)", fill: true, borderWidth: 1, pointRadius: 2, pointHoverRadius: 7 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false,
                        // scales: {
                        //     y: {
                        //         ticks: {
                        //             stepSize: 1  // This sets the increment to 1
                        //         },
                        //         suggestedMin: Math.min(...myWeights, ...wifeWeights) - 2, // Add space below
                        //         suggestedMax: Math.max(...myWeights, ...wifeWeights) + 2  // Add space above
                        //     }
                        // }
                    }
                });

                updateProgressBars(data);
                // Calculate weekly and day one progress
                calculateProgress(data);
                calculateCurrentMonthProgress(data);
            } catch (error){
                console.error("Error fetching data:", error);
            } finally {
                // Hide loading icon after data is loaded
                document.getElementById("loadingOverlay").style.display = "none";
            }
        }

    function updateProgressBars(data) {
        if (data.length === 0) return;

        const latestEntry = data[0];
        const initialEntry = data[data.length - 1]; // Assuming the first entry is the initial weight

        function calculateProgress(currentWeight, initialWeight) {
            const goalWeight = 80;

            // Check if currentWeight is null or invalid
            if (currentWeight === null || currentWeight === undefined) {
                return 0;  // No progress if current weight is missing
            }

            if (currentWeight <= goalWeight) {
                return 100;  // Goal achieved if weight is 80kg or less
            }

            const progress = ((initialWeight - currentWeight) / (initialWeight - goalWeight)) * 100;
            return Math.min(progress, 100);  // Ensure the progress doesn't exceed 100%
        }

        // Calculate progress for Bhavin and Ridham
        const bhavinProgress = calculateProgress(latestEntry.myWeight, initialEntry.myWeight);
        const ridhamProgress = calculateProgress(latestEntry.wifeWeight, initialEntry.wifeWeight);

        // Update the progress bars and text
        document.getElementById("bhavinProgressBar").style.width = bhavinProgress + "%";
        document.getElementById("ridhamProgressBar").style.width = ridhamProgress + "%";

        document.getElementById("bhavinProgressText").textContent = bhavinProgress.toFixed(1) + "%";
        document.getElementById("ridhamProgressText").textContent = ridhamProgress.toFixed(1) + "%";

        // Display message for missing weight values
        if (latestEntry.myWeight === null) {
            const bhavinText = document.getElementById("bhavinProgressText");
            bhavinText.textContent = "N/A";
            bhavinText.style.fontSize = "16px";
            bhavinText.style.fontWeight = "normal";
        } 

        if (latestEntry.wifeWeight === null) {
            const ridhamText = document.getElementById("ridhamProgressText")
            ridhamText.textContent = "N/A";
            ridhamText.style.fontSize = "16px";
            ridhamText.style.fontWeight = "normal";
        }
    }

    function calculateProgress(data) {
        if (data.length === 0) {
            document.getElementById("dayOneProgress").innerHTML = "No data available.";
            document.getElementById("weeklyProgress").innerHTML = "No data available.";
            return;
        }

        function findValidWeight(entry, key) {
            return entry[key] !== null ? entry[key] : null;
        }

        function formatProgress(value) {
            if (isNaN(value) || value === null || value === "N/A") return "N/A"; 
            return value >= 0 ? `+${parseFloat(value).toFixed(3)}` : parseFloat(value).toFixed(3);
        }

        function getValidEntry(index) {
            for (let i = index; i < data.length; i++) {
                if (data[i].myWeight !== null || data[i].wifeWeight !== null) {
                    return data[i];
                }
            }
            return null;
        }

        // Get first and latest valid entries
        const latestEntry = getValidEntry(0);
        const firstEntry = getValidEntry(data.length - 1);

        if (!latestEntry || !firstEntry) {
            document.getElementById("dayOneProgress").innerHTML = "Insufficient data.";
            document.getElementById("weeklyProgress").innerHTML = "Insufficient data.";
            return;
        }

        // Calculate overall progress
        const dayOneProgress = {
            bhavinProgress: latestEntry.myWeight !== null && firstEntry.myWeight !== null
                ? (latestEntry.myWeight - firstEntry.myWeight).toFixed(3)
                : "N/A",
            ridhamProgress: latestEntry.wifeWeight !== null && firstEntry.wifeWeight !== null
                ? (latestEntry.wifeWeight - firstEntry.wifeWeight).toFixed(3)
                : "N/A",
        };

        // Apply background color based on positive or negative progress
        const bhavinDayOneColor = dayOneProgress.bhavinProgress < 0 ? '#d4edda' : '#f8d7da';
        const ridhamDayOneColor = dayOneProgress.ridhamProgress < 0 ? '#d4edda' : '#f8d7da';

        document.getElementById("dayOneProgress").innerHTML = `
            <div style="background-color:${bhavinDayOneColor}; padding: 6px; border-top-right-radius: 10px; border-top-left-radius: 10px;">
                Bhavin: ${formatProgress(dayOneProgress.bhavinProgress)}
            </div>
            <div style="background-color:${ridhamDayOneColor}; padding: 6px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;">
                Ridham: ${formatProgress(dayOneProgress.ridhamProgress)}
            </div>
        `;

        // Calculate weekly progress
        const lastWeekData = data.filter(d => {
            const diff = (new Date() - new Date(d.date)) / (1000 * 3600 * 24);
            return diff <= 7 && (d.myWeight !== null || d.wifeWeight !== null);
        });

        if (lastWeekData.length > 1) {
            const weekEnd = lastWeekData[0];
            const weekStart = lastWeekData[lastWeekData.length - 1];

            const weeklyProgress = {
                bhavin: weekEnd.myWeight !== null && weekStart.myWeight !== null
                    ? (weekEnd.myWeight - weekStart.myWeight).toFixed(3)
                    : "N/A",
                ridham: weekEnd.wifeWeight !== null && weekStart.wifeWeight !== null
                    ? (weekEnd.wifeWeight - weekStart.wifeWeight).toFixed(3)
                    : "N/A",
            };

            const bhavinWeeklyColor = weeklyProgress.bhavin < 0 ? '#d4edda' : '#f8d7da';
            const ridhamWeeklyColor = weeklyProgress.ridham < 0 ? '#d4edda' : '#f8d7da';

            document.getElementById("weeklyProgress").innerHTML = `
                <div style="background-color:${bhavinWeeklyColor}; padding: 6px; border-top-right-radius: 10px; border-top-left-radius: 10px;">
                    Bhavin: ${formatProgress(weeklyProgress.bhavin)}
                </div>
                <div style="background-color:${ridhamWeeklyColor}; padding: 6px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;">
                    Ridham: ${formatProgress(weeklyProgress.ridham)}
                </div>
            `;
        } else {
            document.getElementById("weeklyProgress").innerHTML = `Insufficient data for weekly progress.`;
        }
    }

    function calculateCurrentMonthProgress(data) {
        if (data.length === 0) {
            document.getElementById("currentMonthProgress").innerHTML = "No data available.";
            return;
        }

        const now = new Date();
        const currentMonth = now.getMonth() + 1; // JS months are 0-indexed
        const currentYear = now.getFullYear();

        // Filter entries for the current month
        const monthData = data.filter(d => {
            const dateParts = d.date.split("-");
            const entryYear = parseInt(dateParts[0]);
            const entryMonth = parseInt(dateParts[1]);
            return entryYear === currentYear && entryMonth === currentMonth;
        });

        if (monthData.length < 2) {
            document.getElementById("currentMonthProgress").innerHTML = "Insufficient data.";
            return;
        }

        // Get first and latest entry for the month
        const firstEntry = monthData[monthData.length - 1];
        const latestEntry = monthData[0];

        // Calculate progress
        const monthProgress = {
            bhavin: latestEntry.myWeight !== null && firstEntry.myWeight !== null 
                ? (latestEntry.myWeight - firstEntry.myWeight).toFixed(3) 
                : "N/A",
            ridham: latestEntry.wifeWeight !== null && firstEntry.wifeWeight !== null 
                ? (latestEntry.wifeWeight - firstEntry.wifeWeight).toFixed(3) 
                : "N/A",
        };

        // Determine background color
        const bhavinColor = monthProgress.bhavin < 0 ? '#d4edda' : '#f8d7da';
        const ridhamColor = monthProgress.ridham < 0 ? '#d4edda' : '#f8d7da';

        // Update UI
        document.getElementById("currentMonthProgress").innerHTML = `
            <div style="background-color:${bhavinColor}; padding:6px; border-top-right-radius: 10px; border-top-left-radius: 10px;">
                Bhavin: ${monthProgress.bhavin}
            </div>
            <div style="background-color:${ridhamColor}; padding:6px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; margin-bottom: 4px;">
                Ridham: ${monthProgress.ridham}
            </div>
        `;
    }

    document.getElementById('weightForm').onsubmit = async function(e) {
        e.preventDefault();

        // Get input values
        const date = this.date.value;
        let myWeight = this.my_weight.value ? parseFloat(this.my_weight.value) : null;
        let wifeWeight = this.wife_weight.value ? parseFloat(this.wife_weight.value) : null;

        const unFormattedDate = new Date(this.date.value + "T00:00:00");
        const formattedDate = unFormattedDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });

        if(!myWeight && !wifeWeight){
            // Confirmation message
            alert(`Date: ${formattedDate}\nPlease enter weight...`);
            return; // Stop submission if the user cancels
        }

        // Prepare the form data
        const formData = { date, myWeight, wifeWeight };

        // Check if the date already exists in the database
        const response = await fetch(`${baseURL}/api/weights/${date}`);
        const existingRecord = await response.json();

        if (existingRecord) {
            function validateAndConfirmUpdate(existingRecord, myWeight, wifeWeight, formattedDate) {
                // Case 1: If both weights exist and are unchanged, stop execution
                if (myWeight && wifeWeight && existingRecord.myWeight && existingRecord.wifeWeight) {
                    if (myWeight === existingRecord.myWeight && wifeWeight === existingRecord.wifeWeight) {
                        alert(`Date: ${formattedDate}\nRecord already exists for both Bhavin & Ridham`);
                        return false; // Stop further execution
                    }
                }

                // Case 2: If Bhavin's weight is NULL but Ridham's weight is same as existing
                if (!myWeight && wifeWeight && wifeWeight === existingRecord.wifeWeight) {
                    alert(`Date: ${formattedDate}\nRecord already exists for Ridham`);
                    return false; // Stop execution
                }

                // Case 3: If Ridham's weight is NULL but Bhavin's weight is same as existing
                if (!wifeWeight && myWeight && myWeight === existingRecord.myWeight) {
                    alert(`Date: ${formattedDate}\nRecord already exists for Bhavin`);
                    return false; // Stop execution
                }

                // Case 4: If Bhavin's weight is unchanged, just skip confirmation for him
                let confirmMessage = `Confirmation\n\nDate: ${formattedDate}\n`;
                let needsConfirmation = false;

                if (myWeight && existingRecord.myWeight && myWeight !== existingRecord.myWeight) {
                    confirmMessage += `Bhavin's weight will be updated from ${existingRecord.myWeight} to ${myWeight}\n`;
                    needsConfirmation = true;
                }

                // Case 5: If Ridham's weight is new, allow it to be updated
                if (wifeWeight && existingRecord.wifeWeight && wifeWeight !== existingRecord.wifeWeight) {
                    confirmMessage += `Ridham's weight will be updated from ${existingRecord.wifeWeight} to ${wifeWeight}`;
                    needsConfirmation = true;
                }

                // Show confirmation only if any weight is actually changing
                if (needsConfirmation) {
                    const confirmation = confirm(confirmMessage);
                    if (!confirmation) return false;
                }

                return true; // Proceed with submission
            }

            // Usage inside form submission
            if (!validateAndConfirmUpdate(existingRecord, myWeight, wifeWeight, formattedDate)) {
                return; // Stop execution if validation fails
            }

            // If record exists and only myWeight is set, update wifeWeight
            if (myWeight && !wifeWeight) {
                formData.wifeWeight = existingRecord.wifeWeight;
            } else if (wifeWeight && !myWeight) {
                formData.myWeight = existingRecord.myWeight;
            }

            // Send the updated data to the backend
            await fetch(`${baseURL}/api/weights/${existingRecord.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
        } else {
            // If no record exists for the given date, create a new record
            await fetch(`${baseURL}/api/weights`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
        }

        // Reset the form
        this.reset();

        // Set the date picker to today's date after submission
        const today = new Date();
        const localDate = today.toLocaleDateString('en-CA');
        document.getElementById("datePicker").value = localDate;

        // Optionally, refresh data
        fetchAndUpdate();
    };

        async function deleteWeight(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;

            await fetch(`${baseURL}/api/weights/${id}`, { method: 'DELETE' });

            fetchAndUpdate(); // Refresh table & chart after deletion
        }

        // Fetch data on page load
        fetchAndUpdate();

    </script>

</body>
</html>
